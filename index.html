<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Matthew</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>

    <div class="container">
      <div class="header clearfix">
        <nav>
          <ul class="nav nav-pills pull-right">
            <li role="presentation"><a href="https://github.com/rolandkofler/Matthew">Sources</a></li>
            <li role="presentation"><a href="https://etherscan.io/address/0x75aa81161e07483f6ca199fef46c13eb13d190be#readContract">Deployed Contract</a></li>
            <li role="presentation"><a href="https://github.com/rolandkofler/matthew/blob/master/README.md">Help</a></li>
          </ul>
        </nav>
        <h1 class="text-muted">Matthew <small><sup>beta</sup> - a contract for increasing "whaleth"</small></h1>
      </div>
      <div class="jumbotron" id="jumbo">
        <h1>
          <strong id="blocksTillMatthew">_</strong> blocks until<br>
          <small>0x</small><strong id="matthew">____</strong> wins
          <strong id="stake"> __.__ </strong> Ether<sup>
            <small><small>
            <a style="text-decoration: none;"  data-toggle="tooltip" data-trigger="hover click" title="used as first stake for the next round" data-placement="right" >10% fee</a>
           </small></small>
          </sup><br>
         <small>if you don't top it.</small>
        </h1>

        <hr>
        <div>
          <h2 style="line-height: 150%">
          Oh no, I will pay<br>
          <!--<input class="" type="number" size="4" style="width: 200px;" value = "90.1"/>-->
          <strong id="willpay">__</strong> Ether, but
          <span id="payback">__</span> Ether are returned to me instantly.<br>
          <small>I will <strong>always pay only 0.1 ETH</strong> at last.</small>
          </h2>
        </div>
        <hr>
        <div class="row">
            <button id="payButton" class="btn btn-lg btn-success" href="#" role="button" data-loading-text="Sending..." >Pay With Metamask</button> <span>&nbsp;&nbsp; or from a wallet by sending Ether to <a href="https://etherscan.io/address/0x75aa81161e07483f6ca199fef46c13eb13d190be#readContract" target="_etherscan" class="mattAddr"></a></span>
        </div>
     </div>

      <div class="row marketing">
        <div class="col-lg-6">

          <p>Your Account</p>
          <h4 id="account">loading</h4>

          <p>Your Balance</p>
          <h4 id="balance">loading</h4>

          <p>Periods</p>
          <h4>current <span id="period">___</span>, next <span id="newperiod">___</span></h4>



        </div>

        <div class="col-lg-6">
          <p>Current Winner's full Address</p>
          <h4 id="fullmatthew">loading</h4>

          <p>Current Block</p>
          <h4 id="blockheight">loading</h4>

          <p>Ethereum Network</p>
          <h4 id="ethereumnetwork">loading</h4>


        </div>
      </div>
      <hr/>
      <div class="panel panel-default">
        <!-- Default panel contents -->
        <div class="panel-heading">Events</div>
        <div class="panel-body">
          <p>Reverse History of Events</p>
        </div>

        <!-- List group -->
        <ul id="events" class="list-group">
        </ul>
      </div>

      <footer class="footer">
        <p>Source code on <a href="https://github.com/rolandkofler/Matthew">Github</a></p>
      </footer>

<div id="matthewWonDialog" class="modal fade" tabindex="-1" role="dialog">
<div class="modal-dialog" role="document">
  <div class="modal-content">
    <div class="modal-header">
      <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
      <h3 class="modal-title">Matthew won!</h3>
    </div>
    <div class="modal-body row">
      <div class="col-md-8">
      <h4>Anybody who sends <strong>zero or more Ether to the Contract</strong> will trigger the payout.</h4>
      <p>Tip: paying more than (<span class="tax"></span> + 0.1) ETH means you are staking for the next round.</p>
      <p>Pay to the Matthew Address: <em class="mattAddr"></em></p>
    </div>
    <div class="text-right" class="col-md-1">
      <pre>
╭━━━━━━━━╮┏━╮╭━┓
┃┈┈┈┈┈┈┈┈┃╰╮╰╯╭╯
┃╰╯┈┈┈┈┈┈╰╮╰╮╭╯┈
┣━━╯┈┈┈┈┈┈╰━╯┃┈┈
╰━━━━━━━━━━━━╯┈┈
      </pre></div>
    </div>
    <div class="modal-footer">
      <a id="settlementButton" class="btn btn-lg btn-success" href="#" role="button" >Settle With Metamask</a>
    </div>
  </div><!-- /.modal-content -->
</div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<div class="modal fade" tabindex="-1" role="dialog" id="warningDialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header alert alert-danger">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h3 class="modal-title">WARNING</h3>
        <h4><strong> While the whale looks friendly, Matthew is a nasty animal</strong></h4>
      </div>
      <div class="text-right" class="col-md-1">
        <pre>
                            ╭━━━━━━━━╮┏━╮╭━┓
          HI, I'm Matthew   ┃┈┈┈┈┈┈┈┈┃╰╮╰╯╭╯
            Wanna play      ┃╰╯┈┈┈┈┈┈╰╮╰╮╭╯┈
                with me?    ┣━━╯┈┈┈┈┈┈╰━╯┃┈┈
                            ╰━━━━━━━━━━━━╯┈┈
        </pre>
      </div>

      <div class="modal-body alert alert-danger">
        <p>THIS IS AN EXPERIMENT IN BEHAVIORAL ECONOMICS. Do not stake Ether you will miss later! </p>
        <p>THIS CONTRACT IS NOT SECURE AND COULD BE HACKED. BY USING IT YOU AGREE THAT ANY RISK IS ON YOU.</p>
      </div>
      <div class="modal-footer">
        <a href="https://www.reddit.com/r/ethereum/" type="button" class="btn btn-default" >Get me out of here</a>
        <button type="button" class="btn btn-danger" data-dismiss="modal">OK I risk it</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

</div> <!-- /container -->

    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="https://maxcdn.bootstrapcdn.com/js/ie10-viewport-bug-workaround.js"></script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script src="lib/web3.min.js" type="text/javascript"></script>
    <script >
    function SortedAsyncCaller(callFn, callbackFn) {
    	var caller = this;
    	caller.counter = 0;
    	caller.lastReturnedCall = -1;
    	caller.callFn = callFn;
    	caller.callbackFn = callbackFn;
    	caller.execute = executeCall;

    	function executeCall() {
    		(function(callIndex){
    			callFn(function(error, result) {
    				if (callIndex < caller.lastReturnedCall)
    					return;

    				caller.lastReturnedCall = callIndex;
    				callbackFn(error, result);
    			});
    		})(caller.counter);

    		caller.counter++;
    	}
    }

    window.addEventListener('load', function() {

      // Checking if Web3 has been injected by the browser (Mist/MetaMask)
      if (typeof web3 !== 'undefined') {
        // Use Mist/MetaMask's provider
        web3 = new Web3(web3.currentProvider);
        console.log('MetaMask ready')
      } else {

        console.log('No web3? You should consider trying MetaMask!')
        // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
        web3 = new Web3(new Web3.providers.HttpProvider("https://mainnet.infura.io/4TdcSx2orDpViXyHXQfK"));
      }
     //start app
      $("[data-toggle=tooltip]").tooltip({ 'container': 'body' });
      $('#warningDialog').modal('show');
      mattAddress= "0x75aa81161e07483f6ca199fef46c13eb13d190be";
      $(".mattAddr").html(mattAddress);
      currentPayment= 0;

      $('#payButton').on('click', function () {
          var $btn = $(this).button('loading')
          pay(currentPayment, $btn);
      });

      $('#settlementButton').on('click', function () {
          var $btn = $(this).button('loading')
          pay(0, $btn);
      });

      pay = function(amount, btn){
        if (amount !=0 && !amount) throw amount + " amount is undef";
        tx = {from:web3.eth.accounts[0], to: mattAddress, value: web3.toWei(amount, "ether")};
        console.log("do transaction",tx);
        web3.eth.sendTransaction(tx, function (error, address){
          if (error) throw error;
          console.log("paid %s to %s", amount, mattAddress);
          btn.button('reset');
        });
      };


      var updateInterface = function(){
        if (!matthew) throw "no matthew contract loaded";

        getBlocksTillMathewCaller.execute();
        getWhaleCaller.execute();
        getStakeCaller.execute();
        getPeriodCaller.execute();
        getNewPeriodCaller.execute();
        getNetworkCaller.execute();
        getAccountCaller.execute();
        getBlockNumberCaller.execute();

      }

      matthewContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"getNewPeriod","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getPeriod","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"WINNERTAX_PRECENT","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"stake","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getBlocksTillMatthew","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getDestroyedWhenRoundOver","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"whale","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"destroyWhenRoundOver","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"DELTA","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_newPeriod","type":"uint256"}],"name":"setNewPeriod","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"blockheight","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"},{"payable":true,"type":"fallback"},{"anonymous":false,"inputs":[{"indexed":false,"name":"msg","type":"string"},{"indexed":false,"name":"winner","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"blocknumber","type":"uint256"}],"name":"MatthewWon","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"msg","type":"string"},{"indexed":false,"name":"staker","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"blocknumber","type":"uint256"}],"name":"StakeIncreased","type":"event"}]);
      matthew = matthewContract.at(mattAddress);

      var getBlocksTillMathewCaller = new SortedAsyncCaller
      (
      	matthew.getBlocksTillMatthew.call,

      	function(error, result){
          if (error) throw error;
          var blocksLeft = result.toNumber();
          if (blocksLeft == 0) {
              $('#matthewWonDialog').modal('show');
          }
          else {
              $('#matthewWonDialog').modal('hide');
          }
          $("#blocksTillMatthew").html(blocksLeft);
        }
      );

      var getWhaleCaller = new SortedAsyncCaller
      (
        matthew.whale.call,
        function(error, result){
          if (error) throw error;
          $("#matthew").html(result.substring(2, 6));
          $("#fullmatthew").html(result);
        }
      );

      var getStakeCaller = new SortedAsyncCaller
      (
        matthew.stake.call,
        function(error, result){
          if (error) throw error;
          var stake = web3.fromWei(result, "ether");
          $("#stake").html(stake.times(0.9).toNumber());
          $(".tax").html(stake.times(0.1).toNumber());
          $("#payback").html(stake.toNumber());
          currentPayment = stake.add(0.1).toNumber()
          $("#atleaststake").html(currentPayment);
          $("#willpay").html(currentPayment);
        }
      );

      var getAccountCaller = new SortedAsyncCaller
      (
        web3.eth.getAccounts,
        function(error, result){
          if (error) throw error;
          $("#account").html(result[0]);

          web3.eth.getBalance(result[0], "latest", function(error, result){
            if (error) throw error;
            $("#balance").html(web3.fromWei(result, "ether").toString().concat(" Ether"));
          })
        }
      );

      var getPeriodCaller = new SortedAsyncCaller
      (
        matthew.getPeriod.call,
        function(error, result){
          if (error) throw error;
          $("#period").html(result.toNumber());
        }
      );

      var getNewPeriodCaller = new SortedAsyncCaller
      (
        matthew.getNewPeriod.call,
        function(error, result){
          if (error) throw error;
          $("#newperiod").html(result.toNumber());
        }
      );

      var getNetworkCaller = new SortedAsyncCaller
      (
        web3.version.getNetwork,
        function(error, result){
          if (error) throw error;
          var netname = "Unknown Net: "+ result;
          switch(Number(result)){
            case 1: netname= "Mainnet"; break;
            case 2: netname= "Morden Testnet"; break;
            case 3: netname= "Ropsten Testnet"; break;
          };
          $("#ethereumnetwork").html(netname);
        }
      );

     var getBlockNumberCaller = new SortedAsyncCaller
     (
       web3.eth.getBlockNumber,
       function(error, result){
         if (error) throw error;
         $("#blockheight").html(result);
       }
     );

      var accountInterval = setInterval(function() {
         updateInterface();

      }, 2000);

      // watch for an event with
      var events = matthew.allEvents({fromBlock: 0, toBlock: 'latest'});


      var addMatthewEvent = function(event) {
          var log = "unknown";
          var prefix = "Block "+event.blockNumber+" &ndash; ";
          var style = "";
          switch (event.event){
            case "MatthewWon":
             log = prefix + "<a href='https://etherscan.io/address/"+event.args.winner+"'> <b>" + event.args.winner.substring(2,6) + "</b></a> is the new Matthew, he won <b>"+web3.fromWei(event.args.value, "ether").toString()+" ETH</b>";
             style= "list-group-item-success";
            break;
            case "StakeIncreased":
             log = prefix + "<a href='https://etherscan.io/address/"+event.args.staker+"'> <b>" + event.args.staker.substring(2,6) + "</b></a>  increased the stake by <b>"+web3.fromWei(event.args.value, "ether").toString()+" ETH</b>";
            break;
            default:
             console.error("unknown event", event);
          }

          $('#events').prepend('<li class="list-group-item '+style+'">'+log+'</li>');
      };

      // would get all past logs again.
      events.get(function(error, logs){
        if (error) throw error;

        $.each(logs, function(index,log) {
            addMatthewEvent(log);
        });

        events.watch(function(error, event){
          if (error) throw error;
          addMatthewEvent(event);

        });

      });


    })
    </script>
  </body>
</html>
