<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>Matthew</title>

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css" integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>

    <div class="container">
      <div class="header clearfix">
        <h3 class="text-muted">Matthew <small>- a contract for increasing "whaleth"</small></h3>
      </div>

      <div class="jumbotron">
        <h1>
          <strong id="blocksTillMatthew">_</strong> blocks until<br>
          <small>0x</small><strong id="matthew">____</strong> wins
          <strong id="stake"> __.__ </strong> Ether<sup><a href="#" data-toggle="tooltip" data-trigger="click hover" title="includes a 10% fee for having a stake for the next round">*</a></sup><br>
          <small>if you don't top it.</small>
        </h1>

        <pre>
          ╭━━━━━━━━╮┏━╮╭━┓
          ┃┈┈┈┈┈┈┈┈┃╰╮╰╯╭╯
          ┃╰╯┈┈┈┈┈┈╰╮╰╮╭╯┈
          ┣━━╯┈┈┈┈┈┈╰━╯┃┈┈
          ╰━━━━━━━━━━━━╯┈┈
        </pre>

        <form class= "form-inline">
          <h2>
          Oh no, I will pay<br>
          <!--<input class="" type="number" size="4" style="width: 200px;" value = "90.1"/>-->
          <strong id="willpay">__</strong> Ether and receive <br>
          <span id="payback">90</span> Ether back instantly, so I will pay only 0.1 ETH at the end.
          </h2>
        <a class="btn btn-lg btn-success" href="#" role="button" onclick="pay();">Pay In With Metamask</a> or from a wallet using <a href="https://etherscan.io/address/0x75aa81161e07483f6ca199fef46c13eb13d190be#readContract" target="_etherscan" id="mattAddr"></a>
        </form>
      </div>

      <div class="row marketing">
        <div class="col-lg-6">
          <p>Your Account</p>
          <h4 id="account">loading</h4>

          <p>Your Balance</p>
          <h4 id="balance">loading</h4>

          <p>Periods</p>
          <h4>current: <span id="period">___</span> next: <span id="newperiod">___</span></h4>

        </div>

        <div class="col-lg-6">
          <p>Current Winner's full Address</p>
          <h4 id="fullmatthew">loading</h4>

          <p>Current Block</p>
          <h4 id="blockheight">loading</h4>

          <p>Ethereum Network</p>
          <h4 id="ethereumnetwork">loading</h4>

        </div>
      </div>
      <hr/>
      <footer class="footer">
        <p>Source code on <a href="https://github.com/rolandkofler/Matthew">Github</a></p>
      </footer>

    </div> <!-- /container -->


    <!-- IE10 viewport hack for Surface/desktop Windows 8 bug -->
    <script src="https://maxcdn.bootstrapcdn.com/js/ie10-viewport-bug-workaround.js"></script>

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js" integrity="sha384-Tc5IQib027qvyjSMfHjOMaLkfuWVxZxUPnCJA7l2mCWNIpG9mGCD8wGNIcPD7Txa" crossorigin="anonymous"></script>

    <script >
    window.addEventListener('load', function() {

      // Checking if Web3 has been injected by the browser (Mist/MetaMask)
      if (typeof web3 !== 'undefined') {
        // Use Mist/MetaMask's provider
        web3 = new Web3(web3.currentProvider);
        console.log('MetaMask ready')
      } else {
        console.log('No web3? You should consider trying MetaMask!')
        // fallback - use your fallback strategy (local node / hosted node + in-dapp id mgmt / fail)
        web3 = new Web3(new Web3.providers.HttpProvider("http://localhost:8545"));
      }
     //start app
      mattAddress= "0x75aa81161e07483f6ca199fef46c13eb13d190be";
      $("#mattAddr").html(mattAddress);
      var currentPayment= 0;

      pay = function(){
        if (!currentPayment) throw "current payment is undef";
        tx = {from:web3.eth.accounts[0], to: mattAddress, value: web3.toWei(currentPayment, "ether")};
        console.log(tx);
        web3.eth.sendTransaction(tx, function (error, address){
          if (error) throw error;
          console.log("paid %s to %s", currentPayment, mattAddress);
        });

      };
      updateInterface = function(){
        if (!matthew) throw "no matthew contract loaded";
        matthew.getBlocksTillMatthew.call(function(error, result){
          if (error) throw error;
          $("#blocksTillMatthew").html(result.toNumber());
        });

        matthew.whale.call(function(error, result){
          if (error) throw error;
          $("#matthew").html(result.substring(2, 6));
          $("#fullmatthew").html(result);

        });

        matthew.stake.call(function(error, result){
          if (error) throw error;
          var stake = web3.fromWei(result, "ether");
          $("#stake").html(stake.times(0.9).toNumber());
          $("#payback").html(stake.toNumber());
          currentPayment = stake.add(0.1).toNumber()
          $("#atleaststake").html(currentPayment);
          $("#willpay").html(currentPayment);
        });

        web3.eth.getAccounts(function(error, result){
          if (error) throw error;
          $("#account").html(result[0]);

          web3.eth.getBalance(result[0], "latest", function(error, result){
            if (error) throw error;
            $("#balance").html(web3.fromWei(result, "ether").toString().concat(" Ether"));
          })
        });

        matthew.getPeriod.call(function(error, result){
          if (error) throw error;
          $("#period").html(result.toNumber());


        });

        matthew.getNewPeriod.call(function(error, result){
          if (error) throw error;
          $("#newperiod").html(result.toNumber());

        });

        web3.version.getNetwork(function(error, result){
          if (error) throw error;
          var netname = "Unknown Net: "+ result;
          switch(Number(result)){
            case 1: netname= "Mainnet"; break;
            case 2: netname= "Morden Testnet"; break;
            case 3: netname= "Ropsten Testnet"; break;
          };
          $("#ethereumnetwork").html(netname);
        });

       web3.eth.getBlockNumber(function(error, result){
         if (error) throw error;

         $("#blockheight").html(result);
       });

        console.log("interface updated");
      }

      matthewContract = web3.eth.contract([{"constant":true,"inputs":[],"name":"getNewPeriod","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getPeriod","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"WINNERTAX_PRECENT","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"stake","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getBlocksTillMatthew","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"getDestroyedWhenRoundOver","outputs":[{"name":"","type":"bool"}],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"whale","outputs":[{"name":"","type":"address"}],"payable":false,"type":"function"},{"constant":false,"inputs":[],"name":"destroyWhenRoundOver","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"DELTA","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"constant":false,"inputs":[{"name":"_newPeriod","type":"uint256"}],"name":"setNewPeriod","outputs":[],"payable":false,"type":"function"},{"constant":true,"inputs":[],"name":"blockheight","outputs":[{"name":"","type":"uint256"}],"payable":false,"type":"function"},{"inputs":[],"payable":false,"type":"constructor"},{"payable":true,"type":"fallback"},{"anonymous":false,"inputs":[{"indexed":false,"name":"msg","type":"string"},{"indexed":false,"name":"winner","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"blocknumber","type":"uint256"}],"name":"MatthewWon","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"msg","type":"string"},{"indexed":false,"name":"staker","type":"address"},{"indexed":false,"name":"value","type":"uint256"},{"indexed":false,"name":"blocknumber","type":"uint256"}],"name":"StakeIncreased","type":"event"}]);
      matthew = matthewContract.at(mattAddress);
      var accountInterval = setInterval(function() {
         updateInterface();

      }, 500);



    })
    </script>
  </body>
</html>
